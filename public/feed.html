<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/heade&footer.css">
    <link rel="stylesheet" href="../css/feed.css">
    <link rel="stylesheet" href="css/alerta.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <title>Feed | Till the Fangz</title>
</head>

<body onload="buscarPeloId(sessionStorage.ID_USUARIO), validarSessao(), atualizarFeed()">
    <header id="header"></header>
    <div id="containerSair"></div>
    <div id="div_Alerta" class="alerta">
        <img class="morcego" src="assets/img/morcegoCimaPreto.png">
        <div id="conteudo_alerta"></div>
    </div>

    <div class="tudo">

        <div class="container">

            <div class="conteudo">

                <h1>Feed:</h1>
                <div class="ferramentas">
                    <button onclick="
                    if(sessionStorage.ID_USUARIO!=undefined){
                        editar.showModal()
                    }
                    else{
                        funcao_alerta()
                        setTimeout(() => redirecionar(),3000)
                        
                    }"> <i class='bx bx-edit'></i> novo post</button>
                </div>
                <dialog id="editar">
                    <div class="Containerpublicar">
                        <h1>Publicar</h1>
                        <div class="div-form">
                            Título:
                            <input name="titulo" maxlength="50" maxlength="100" type="text" id="div_titulo">
                            Descrição:
                            <textarea name="conteudo" maxlength="1000" maxlength="250" rows="5" id="div_conteudo"></textarea >
                                    <div class="tagsPostar">
                                        Tags:
                                        <div class="totalTags">
                                        <div class="Header Jogador">
                                            <a onclick="">Jogador</a>
                                        </div>
                                        <div class="conteudoPostTags">
                                            <a href="">O mestre</a>
                                            <a href="">O player</a>
                                        </div>
                                        <div class="Header Raca">
                                            <a onclick="">Raça</a>
                                        </div>
                                    
                                        <div class="Header Classe">
                                            <a onclick="">Classe</a>
                                        </div>
                                        </div>
                                    </div>
                                <svg id="uploadIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                    fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M21 14V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h9v-2H5v-1.59l3-3 1.29 1.29c.39.39 1.02.39 1.41 0l5.29-5.29 3 3V14h2Zm-4.29-5.71a.996.996 0 0 0-1.41 0l-5.29 5.29-1.29-1.29a.996.996 0 0 0-1.41 0l-2.29 2.29V5h14v5.59L16.73 8.3Z">
                                    </path>
                                    <path
                                        d="M8.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 1 0 0-3M21 16h-2v3h-3v2h3v3h2v-3h3v-2h-3z">
                                    </path>
                                </svg>

                                <input type="file" id="input_imagens" accept="image/*">

                                <div class="previa">
                                    <img id="Previa" src="" alt="" style="display: none;">
                                </div>

                                <button onclick="publicar()">Enviar</button>
                            

                            <!-- <form id="form_postagem" method="post" onsubmit="return publicar()">
                                <label>
                                    Título:
                                    <br>
                                    <input name="titulo" maxlength="50" id="titulo" maxlength="100" type="text">
                                </label>
                                <br>
                                <label>
                                    <input type="file">
                                </label>
                                <br>
                                <br>
                                <label>
                                    Descrição:
                                    <br>
                                    <textarea name="conteudo" maxlength="1000" id="textarea_descricao" maxlength="250"
                                        rows="5"></textarea>
                            </label>
                            <br>
                            <button>Enviar</button>
                            </form> -->
                        </div>
                    </div>
                </dialog>


                <div id="feed_container" class="feedContainer">
                </div>

            </div>

        </div>
        <div class="pesquisaTags">
            Tags:
            <div class="itensTag">
                <div class="tagss">
                    <a onclick="aparecer('Jogador')">
                        <h2>Jogador</h2>
                    </a>
                    <div class="separacao">
                        <div id="Jogador">
                            <a onclick="SalvarTag('jogador','O Mestre')">
                                <p>O Mestre</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Player')">
                                <p>O Player</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Ator')">
                                <p>O Ator</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Observador')">
                                <p>O observador</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Engajado')">
                                <p>O engajado</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Comentador')">
                                <p>O comentador</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Investigador')">
                                <p>O Investigador</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Narrador')">
                                <p>O Narrador</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Solitario')">
                                <p>O solitário</p>
                            </a>
                            <a onclick="SalvarTag('jogador','O Piadista')">
                                <p>O piadista</p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="itensTag">
                <div class="tagss">

                    <a onclick="aparecer('Racas')">
                        <h2>Raças</h2>
                    </a>
                    <div class="separacao">
                        <div id="Racas">
                            <A onclick="SalvarTag('racas', 'Monstro')">
                                <p>Monstro</p>
                            </A>
                            <a onclick="SalvarTag('racas','Vampiro')">
                                <p>Vampiro</p>
                            </a>
                            <a onclick="SalvarTag('racas', 'Anjo')">
                                <p>Anjo</p>
                            </a>
                            <a onclick="SalvarTag('raca','Demonio')">
                                <p>Demonio</p>
                            </a>
                            <a onclick="SalvarTag('raca','Bruxa')">
                                <p>Bruxa</p>
                            </a>
                            <a onclick="SalvarTag('raca','Corrompido')">
                                <p>Corrompido</p>
                            </a>
                        </div>

                    </div>
                </div>
            </div>
            <div class="itensTag">
                <div class="tagss">

                    <a onclick="aparecer('Classe')">
                        <h2>Classes</h2>
                    </a>
                    <div class="separacao">
                        <div id="Classe">
                            <a onclick="SalvarTag('classes','Caçador')">
                                <p>Caçador</p>
                            </a>
                            <a onclick="SalvarTag('classes','Senhor das sombras')">
                                <p>Senhor das Sombras</p>
                            </a>
                            <a onclick="SalvarTag('classes','Barbaro')">
                                <p>Barbaro</p>
                            </a>
                            <a onclick="SalvarTag('classes','Ilusionista')">
                                <p>Ilusionista</p>
                            </a>
                            <a onclick="SalvarTag('classes','Cultista')">
                                <p>Cultistas</p>
                            </a>
                            <a onclick="SalvarTag('classes', 'Iluminado')">
                                <p>Iluminado</p>
                            </a>
                            <a onclick="SalvarTag('classes', 'Flagelador')">
                                <p>Flagelador</p>
                            </a>
                            <a onclick="SalvarTag('classes','Canibal')">
                                <p>Canibal</p>
                            </a>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- <footer>
        <div class="footer-links">
            <h4>Links Rápidos</h4>
            <ul>
                <li><a href="/sobre.html">Sobre Mim</a></li>
            </ul>
        </div>
        <div class="footer-copyright">
            <p>&copy; 2025 Till the FangZ. Todos os direitos reservados.</p>
        </div>
    </footer> -->
</body>
<script>

</script>

</html>
<script src="js/div_alerta.js"></script>
<script src="js/sessao.js"></script>
<script src="js/header.js"></script>
<script>
    // function validacaoNomes(){
    //     if(sessionStorage.NICKNAME_USUARIO){
    //  }
    // }
    const inputUpload = document.getElementById("input_imagens");
    const previaImagem = document.getElementById("Previa");
    const uploadIcon = document.getElementById("uploadIcon");

    uploadIcon.addEventListener('click', () => {
        inputUpload.click();
    });

    inputUpload.addEventListener('change', () => {
        const arquivo = inputUpload.files[0];
        if (arquivo) {
            const leitor = new FileReader();
            leitor.onload = function (e) {
                previaImagem.src = e.target.result;
                previaImagem.style.display = 'block';
            };
            leitor.readAsDataURL(arquivo);
        }
    });
    
    function redirecionar() {
        window.location = 'login.html'
    }
    function funcao_alerta(texto) {
        div_Alerta.style.display = "block"
        requestAnimationFrame(() => {
            div_Alerta.classList.add('aparecer');
        });
        conteudo_alerta.innerHTML =
            `
            Você não está logado, redirecionando para a página de login 
            <div id='div_aguardar' class='loading-div'>
                <img src='./assets/carregando.gif' x id='loading-gif'>
            </div>
            `
    }
    Racas.style.display = 'none'
    Jogador.style.display = 'none'
    Classe.style.display = 'none'

    let cliquesJogador = 0;
    let cliquesClasse = 0;
    let cliquesRacas = 0;

    function aparecer(qual) {

        if (qual == 'Jogador' && cliquesJogador == 0) {
            Jogador.style.display = 'block'
            cliquesJogador++
        }
        else if (qual == 'Jogador' && cliquesJogador == 1) {
            Jogador.style.display = 'none'
            cliquesJogador = 0
        }

        if (qual == 'Racas' && cliquesRacas == 0) {
            Racas.style.display = 'block'
            cliquesRacas++
        }
        else if (qual == 'Racas' && cliquesRacas == 1) {
            Racas.style.display = 'none'
            cliquesRacas = 0
        }

        if (qual == 'Classe' && cliquesClasse == 0) {
            Classe.style.display = 'block'
            cliquesClasse++
        }
        else if (qual == 'Classe' && cliquesClasse == 1) {
            Classe.style.display = 'none'
            cliquesClasse = 0
        }

    }
    // function limparFormulario() {
    //     document.getElementById("form_postagem").reset();
    // }

    function publicar() {
        const tituloDiv = document.getElementById('div_titulo').value;
        const conteudoDiv = document.getElementById('div_conteudo').value;
        var idUsuario = sessionStorage.ID_USUARIO;

        var corpo = {
            titulo: tituloDiv,
            descricao: conteudoDiv,
            tag: [],
            imagem: inputUpload.value
        }

        fetch(`/avisos/publicar/${idUsuario}`, {
            method: "post",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(corpo)
        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {
                // window.alert("Post realizado com sucesso pelo usuario de ID: " + idUsuario + "!");
                window.location = "/feed.html";
                //limparFormulario();
                finalizarAguardar();
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
            finalizarAguardar();
        });

        return false;

    }


    function atualizarFeed() {
        const card = document.getElementById('div_card')
        fetch("/avisos/listar").then(function (resposta) {
            if (resposta.ok) {
                if (resposta.status == 204) {
                    var feed = document.getElementById("feed_container");
                    var mensagem = document.createElement("span");
                    mensagem.innerHTML = "Nenhum resultado encontrado."
                    feed.appendChild(mensagem);
                    throw "Nenhum resultado encontrado!!";
                }

                resposta.json().then(function (resposta) {
                    console.log("Dados recebidos: ", JSON.stringify(resposta));

                    var feed = document.getElementById("feed_container");
                    feed.innerHTML = "";
                    for (let i = 0; i < resposta.length; i++) {
                        var publicacao = resposta[i];
                        feed_container.innerHTML +=
                            `
                        <div class="card" id="div_card">
                            <div class="cabecalho">
                                <img src="assets/img/vampireUser.png">
                                <p id="nickname">${publicacao.nome}</p>
                                <div class="tags">
                                    <p id="tagPost"></p>
                                </div>
                            </div>
                            <div class="conteudo">
                                <div class='tituloPublicacao'><h3>${publicacao.titulo}</h3></div>
                                <div class="imagem">
                                    <img src="" id="imagemPost">
                                </div>
                                <p id="conteudoPost">${publicacao.conteudo}</p>
                            </div>
                        </div>
                        `

                        // criando e manipulando elementos do HTML via JavaScript
                        // var divPublicacao = document.createElement("div");
                        // var spanID = document.createElement("span");
                        // var spanTitulo = document.createElement("span");
                        // var spanNome = document.createElement("span");
                        // var divDescricao = document.createElement("div");
                        // var divButtons = document.createElement("div");
                        // var btnEditar = document.createElement("button");
                        // var btnDeletar = document.createElement("button");


                        // spanID.innerHTML = "ID: <b>" + publicacao.idAviso + "</b>";
                        // spanTitulo.innerHTML = "Título: <b>" + publicacao.titulo + "</b>";
                        // spanNome.innerHTML = "Autor: <b>" + publicacao.nome + "</b>";
                        // divDescricao.innerHTML = "Descrição: <b>" + publicacao.descricao + "</b>";
                        // btnEditar.innerHTML = "Editar";
                        // btnDeletar.innerHTML = "Deletar";

                        // divPublicacao.className = "publicacao";
                        // spanTitulo.id = "inputNumero" + publicacao.idAviso;
                        // spanNome.className = "publicacao-nome";
                        // spanTitulo.className = "publicacao-titulo";
                        // divDescricao.className = "publicacao-descricao";

                        // divButtons.className = "div-buttons"

                        // btnEditar.className = "publicacao-btn-editar"
                        // btnEditar.id = "btnEditar" + publicacao.idAviso;
                        // btnEditar.setAttribute("onclick", `editar(${publicacao.idAviso})`);

                        // btnDeletar.className = "publicacao-btn-editar"
                        // btnDeletar.id = "btnDeletar" + publicacao.idAviso;
                        // btnDeletar.setAttribute("onclick", `deletar(${publicacao.idAviso})`);

                        // divPublicacao.appendChild(spanID);
                        // divPublicacao.appendChild(spanNome);
                        // divPublicacao.appendChild(spanTitulo);
                        // divPublicacao.appendChild(divDescricao);
                        // divPublicacao.appendChild(divButtons);
                        // divButtons.appendChild(btnEditar);
                        // divButtons.appendChild(btnDeletar);
                        // feed.appendChild(divPublicacao);
                    }

                    // finalizarAguardar();
                });
            } else {
                throw ('Houve um erro na API!');
            }
        }).catch(function (resposta) {
            console.error(resposta);
            finalizarAguardar();
        });
    }

</script>