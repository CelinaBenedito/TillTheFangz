<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/user.css">
    <link rel="stylesheet" href="../css/heade&footer.css">
    <link rel="stylesheet" href="../css/alerta.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>User</title>
</head>

<body onload="buscarPeloId(sessionStorage.ID_USUARIO)">
    <header id="header"></header>
    <div id="containerSair"></div>


    <div class="container">
        <div class="imgUser" id="imagem_usuario">
            <img src="assets/img/vampireUser.png" alt="">
        </div>


        <div class="nomeclaturas">
            <div>
                <h2 id="nickname"></h2>
            </div>
            <div class="nome">
                <h2 id="primeiro_nome">Nome</h2>
                <h2 id="sobrenome">Sobrenome</h2>
            </div>

        </div>
        <p id="pronomes" class="pronomes">Pronomes</p>
        <button class="editarBotao" onclick=" editar.showModal()">Editar Perfil</button>
        <dialog id="editar">
            <div class="containerEditar">
                <h1>Editar Perfil</h1>

                <div class="editarIMG">
                    Imagem de Perfil:
                    <input type="file" id="foto" accept="image/*">
                </div>


                <div>
                    Nickname:
                    <input type="text" id="nicknameInput" placeholder="Digite seu nickname">
                </div>



                Pronomes:
                <input type="text" id="pronomesInput" placeholder="Ex: ele/dele, ela/dela...">


                Descrição:
                <textarea id="descricaoInput" rows="3" maxlength="500" placeholder="Fale um pouco sobre você..."
                    oninput="qtdCaracteres()"></textarea>
                <div class="avisoCaracteres">
                    <p id="avisoCaracteres"></p>
                </div>

                <div class="botoesDialog">
                    <button type="submit" onclick="enviar(), editar.close()">Salvar</button>
                    <button type="button" onclick="document.getElementById('editar').close()">Cancelar</button>
                </div>

            </div>
        </dialog>

        <p id="descricao">Adicionar Descrição</p>

        <div class="partePersonagens">
            <h3>Personagens:</h3>
            <div class="botaoCriarficha">
                <a href="ficha.html">
                    <button>+</button>
                </a>
            </div>
            <div id="div_conteudo" class="personagens">
                <h2>Nenhum Personagem Encontrado</h2>
            </div>
        </div>

    </div>
    <div id="div_Alerta" class="alerta">
        <img class="morcego" src="assets/img/morcegoCimaPreto.png">
        <div id="conteudo_alerta"></div>
    </div>
    <footer>
        <div class="footer-links">
            <h4>Links Rápidos</h4>
            <ul>
                <li><a href="/sobre.html">Sobre Mim</a></li>
            </ul>
        </div>
        <div class="footer-copyright">
            <p>&copy; 2025 Till the FangZ. Todos os direitos reservados.</p>
        </div>
    </footer>

</body>

</html>
<script src="js/header.js"></script>
<script src="js/div_alerta.js"></script>
<script>
    let ID_USUARIO = sessionStorage.ID_USUARIO;

    fetch(`/personagens/listar/${ID_USUARIO}`, {
        method: "GET"
    })
        .then(res => {
            res.json().then(json => {
                const personagem = json[0];

                console.log(json.length)
                if (personagem.id != undefined) {
                    div_conteudo.innerHTML = ""
                    for (let c = 0; json.length > c; c++) {
                        let personagem = json[c]
                        div_conteudo.innerHTML +=
                            `
                                       <a onclick="${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}.showModal()">
                                            <div class="cardPersonagem">
                                                <div class="nomePersonagem">
                                                    <p id="nomeclatura">${personagem.apelido} - ${personagem.nome}</p>
                                                </div>
                                                <div class="infos">
                                                    <div class="pontoItem">
                                                    <p id="pts_vida">Vida</p> ${personagem.vida}
                                                    </div>
                                                    <div class="pontoItem">
                                                    <p id="pts_sanidade">Sanidade</p> ${personagem.sanidade}
                                                    </div>
                                                    <div class="pontoItem">
                                                    <p id="classe">Classe</p> ${personagem.classe}
                                                    </div>
                                                </div>
                                            </div>
                                        </a>
                                        <dialog id="${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}">
                                             <div class="informacoes">
                                                
                                                <h1>${personagem.apelido}</h1>
                                                <h2>${personagem.nome}</h2>
                                                <div class="pontosBasicos">
                                                    <div class="itemBase">Vida:<p id="vida"></p>
                                                    </div>
                                                    <div class="itemBase">Sanidade: <p id="sanidade"></p>
                                                        </div>
                                                    <div class="itemBase">Defesa: <p id="defesa"></p>
                                                    </div>
                                                </div>
                                                <div class="infosBase">
                                                    <p>Altura: ${personagem.altura}</p>
                                                    <p>Peso: ${personagem.peso}</p>
                                                    <p>Idade: ${personagem.idade}</p>
                                                    <p>Gênero: ${personagem.genero}</p>
                                                </div>
                                                <div class="detalhesTexto">
                                                    <div class="texto">
                                                    <h3>Historia do Personagem</h3>
                                                    <p id="historiaPersonagem">
                                                        ${personagem.historia}
                                                    </p>
                                                    </div>
                                                    <div class="texto">
                                                        <h3>Caracteristicas do Personagem</h3>
                                                        <p id="caracteristicasPersonagem">
                                                            ${personagem.caracteristicas}
                                                        </p>
                                                    </div>
                                                </div>
                                                <div class="classe">
                                                    <h3>Classe: </h3>
                                                    <p>
                                                        ${personagem.classe}
                                                    </p>    
                                                </div>
                                                <div id="grafico${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}" class="grafico" style="width: 50%; height: 50%">
                                                    <h3>Atributos</h3>
                                                    <canvas id="graficoAtributos${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}" style="background-color: rgb(10, 7, 7); border-radius: 15px;"></canvas>
                                                </div>
                                              
                                                <div class="botaoFechar">
                                                    <button onclick="${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}.close()">Voltar</button>
                                                </div>
                                            </div>
                                        </dialog>
                                    `
                        if (personagem.carisma == 0 && personagem.inteligencia == 0 && personagem.agilidade == 0 && personagem.vigor == 0 && personagem.SangueAncestral == 0) {
                            const idPersonalizadoPersonagem = ` grafico${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}`
                            idPersonalizadoPersonagem.innerHTML =
                                `
                    <h3>Atributos</h3>
                    <p>Nenhum ponto adicionado</p>
                    `
                        } else {

                            const idPersonalizadoPersonagem = `graficoAtributos${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, "")}_${c}`
                            setTimeout(() => {
                                let canvas = document.getElementById(`graficoAtributos${personagem.nome.replaceAll(/[^a-zA-Z0-9]/g, '')}_${c}`);
                                if (canvas) {
                                    let dadosAtributos = {
                                        labels: ['Carisma', 'Inteligência', 'Agilidade', 'Vigor', 'Sangue Ancestral'],
                                        datasets: [{
                                            label: 'Atributos',
                                            data: [personagem.carisma, personagem.inteligencia, personagem.agilidade, personagem.vigor, personagem.SangueAncestral],
                                            borderColor: 'rgba(255, 0, 0, 1)',
                                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                                            borderWidth: 2,
                                            pointBackgroundColor: 'rgba(255, 0, 0, 1)'
                                        }]
                                    };
                                    const config = {
                                        type: 'radar',
                                        data: dadosAtributos,
                                        options: {
                                            animation: {
                                                duration: 150,
                                                easing: 'easeOutBounce',
                                                responsive: true,
                                                maintainAspectRatio: false,
                                            },
                                            scales: {
                                                r: {
                                                    beginAtZero: true,
                                                    min: 0,
                                                    max: 5,
                                                    ticks: {
                                                        stepSize: 1,
                                                        display: false
                                                    },
                                                    grid: {
                                                        color: 'rgba(255, 255, 255, 0.582)'
                                                    },
                                                    pointLabels: {
                                                        color: 'white',
                                                        font: {
                                                            size: 14,
                                                            family: 'Arial',
                                                            weight: 'bold'
                                                        }
                                                    }
                                                }
                                            },
                                            elements: {
                                                line: {
                                                    borderWidth: 3
                                                }
                                            }
                                        }
                                    };
                                    let atributos = new Chart(
                                        document.getElementById(`${idPersonalizadoPersonagem}`),
                                        config
                                    );
                                }
                            }, 50);
                        }
                    }

                }

            })
        })



    /*Quantidade de caracteres da descrição*/
    function qtdCaracteres() {
        let descricao = descricaoInput.value;
        let tamanhoDescricao = descricao.length;
        let quantidadeRestante = 500 - tamanhoDescricao;
        avisoCaracteres.innerHTML = `Caracteres usados: ${tamanhoDescricao}`
        if (quantidadeRestante < 100) {
            avisoCaracteres.innerHTML = `Caracteres usados: <strong>${tamanhoDescricao}</strong>
        <br> Caracteres disponiveis <strong>${quantidadeRestante}</strong>`
        }
    }

    function buscarPeloId(id_user) {

        fetch(`/usuarios/${id_user}`, {
            method: "GET"
        })
            .then(res => {
                res.json().then(json => {
                    const usuario = json[0];
                    console.log(usuario.ImagemUsuario)
                    primeiro_nome.innerHTML = `${usuario.nome}`
                    sobrenome.innerHTML = `${usuario.sobrenome}`
                    nickname.innerHTML = `${usuario.nickname}`
                    imagem_usuario.innerHTML = `<img src='assets/imagensdePerfil/${usuario.ImagemUsuario}' alt="imagem de usuario">`
                    imagem_usuario_header.innerHTML = `<img src='assets/imagensdePerfil/${usuario.ImagemUsuario}' alt="imagem de usuario">`
                })

            })
            .catch(err => {
                console.log(err);

            })

    }


    function enviar() {
        mostrar()
        const formData = new FormData();
        formData.append('foto', foto.files[0])
        let ID_USUARIO = sessionStorage.ID_USUARIO;
        sessionStorage.IMAGEM_USUARIO = foto.files[0]

        fetch(`/usuarios/cadastro/${ID_USUARIO}`, {
            method: "POST",
            body: formData
        })
            .catch(err => {
                console.log("Caiu no catch")
                console.log(err);
            })

        // return window.location.reload();
    }
    function mostrar() {
        let mostrarNome = chk_nome.checked;
        let mostrarSobrenome = chk_sobrenome.checked;
        let mostrarNickname = chk_nickname.checked;
        let nome = sessionStorage.NOME_USUARIO;
        let sobrenome = sessionStorage.SOBRENOME_USUARIO;
        let nickname = sessionStorage.NICKNAME_USUARIO;

        if (mostrarNome == true) {
            primeiro_nome.innerHTML = `${nome}`
        }
        else {
            primeiro_nome.innerHTML = ``
        }

        if (mostrarSobrenome == true) {
            sobrenome.innerHTML = `${sobrenome}`
        }
        else {
            sobrenome.innerHTML = ``
        }

        if (mostrarNickname == true) {
            nickname.innerHTML = `${nickname}`
        }
        else {
            nickname.innerHTML = ``
        }
    }
</script>